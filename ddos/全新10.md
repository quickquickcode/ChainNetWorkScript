3.2.3.10 DDoS交易广播转发抵抗能力（实施稿）
----------------------------------------

定义
- 在恶意交易泛滥的条件下，链网节点对合法交易保持广播与转发能力，同时对恶意交易执行识别和丢弃的能力。
- 强调“合法交易不中断 + 恶意交易被压制”的双重目标，是链网抵御交易类DDoS攻击的核心环节。

指标
- 合法交易转发率 LTR = 成功转发的合法交易数 ÷ 合法交易总数。
- 恶意交易拒绝率 MTR = 被拒绝转发的恶意交易数 ÷ 识别出的恶意交易总数。
观测源：节点 `txpool.content` / `eth_getTransaction`、攻击账户环境变量、可选远程矿工 RPC、tcpdump 数据。

测量方案
1. 发送节点分工：节点 A 运行背景流量脚本发送正常交易；节点 B 运行 DDoS 流量脚本投放恶意交易。脚本在发送前解锁所需账户并获取最新 pending nonce，结合轮询账户映射确保每笔交易 `from` / `to` 不冲突。
2. 监测节点：检测脚本仅通过 IPC/RPC 周期性调用 `txpool.content`，按 `from` 地址聚合已观察到的 nonce；远程矿工 RPC 用于提升覆盖率。
3. 对每个地址维护最小/最大 nonce 及其间缺失的 nonce：
	- 合法账户总发送数 = Σ(max_nonce - min_nonce + 1)；已转发数 = 观测到的 nonce 数量，LTR = 已转发 ÷ 总发送。
	- 恶意账户总识别数 = Σ(max_nonce - min_nonce + 1)；拒绝数 = 缺失 nonce 数量（超出 `--reject-delay` 仍未出现），MTR = 拒绝 ÷ 总识别。
	- 非常规情况（nonce 迟到）：一旦补齐会从“待定”或“拒绝”转入已转发，指标自动修正。
4. 近 30 s 滑动窗口：仅统计首见时间戳在窗口内的 nonce；可通过 `--window` 调整。
5. 待定态（pending）用于表示缺失 nonce 尚未超过判定延迟，控制台会同时输出 pending 数量帮助研判。
6. 统计窗口与轮询间隔可配置，脚本可选写入 JSONL 快照，便于复现与审计。

脚本说明（位于 ddos 目录）
- `background_traffic_sender.py`：通过 IPC `/root/Work/PraviteChain/geth.ipc` 连至节点 A，缺省情况下按账户列表轮流选取 `from` / `to`（确保不同账户），发送前解锁所有参与账户并按顺序打印交易哈希与 nonce，便于对照监测输出。
- `ddos_attack_sender.py`：可通过 `--ipc /root/Work/PraviteChain/geth.ipc` 连接本地节点，也可用 `--rpc http://<远程节点>:8545` 调用远端节点；支持从环境变量（默认 `ATTACKER_KEYSTORE`）载入 keystore JSON（解锁口令仍由 `--passphrase` 提供）并在本地签名后以 `eth_sendRawTransaction` 广播，适用于远端节点无托管账户的场景；脚本输出 `export ATTACKER_ACCOUNTS=...` 并暂停 10 s 以便复制，再以递增 nonce 发送恶意交易并在控制台标注成功/失败。
- `ddos_monitor.py`：本地 IPC 连接 `/root/Work/PraviteChain/geth.ipc`，并可通过 `--legit-rpc`、`--attack-rpc`、`--supplement-rpc` 接入三个远程探针：合法探针提供合法交易分母，恶意探针提供恶意交易分母，补充探针与本地节点共同组成分子。脚本利用 `ATTACKER_ACCOUNTS` 区分恶意地址，仍以 nonce 覆盖统计 LTR/MTR，两行固定中文提示保持不变，支撑累计与滑窗观测，可用 `--output` 输出 JSONL 快照。

操作步骤
前置流程
1. 验证参与节点均已创建账户且余额充足，可支撑后续交易。
2. 在被攻击节点导出目标 keystore（示例：`cat /path/to/keystore/...`）。
3. 将 keystore 拷贝到攻击节点，并通过 `export ATTACKER_KEYSTORE='...'` 设置环境变量。
4. 启动攻击脚本，等待输出 `export ATTACKER_ACCOUNTS=...` 命令后暂时暂停发送，将该命令复制到监测节点。
5. 在监测节点依次确认合法流量探针、恶意探针、补充探针地址，然后启动监测脚本。
6. 恢复攻击脚本发送交易。
7. 启动背景流量脚本，维持合法交易基线。

1. 在背景流量节点运行 `python3 background_traffic_sender.py --ipc /root/Work/PraviteChain/geth.ipc --count 200 --passphrase 123`（如需固定账户可加 `--from-index` / `--to`），脚本会轮流选择账户发送合法交易并在控制台标注发送结果。
2. 若需要使用远端节点的 keystore：
   - 在远端导出密钥文件后复制到本地主机，例如保存为 `attacker_keystore.json`。
   - 使用单引号设置环境变量，确保 JSON 字符串不被 shell 改写：
     ```sh
     export ATTACKER_KEYSTORE='{"address":"88de05835105ffa147d68761b5c748b0cb771228","crypto":{"cipher":"aes-128-ctr","ciphertext":"e2c67a46b688c77973a20df6068b5694e110af82617836afee709715a062fd0c","cipherparams":{"iv":"8f4121bade6f9dc37cf7ab0e20802891"},"kdf":"scrypt","kdfparams":{"dklen":32,"n":262144,"p":1,"r":8,"salt":"23d9a49a29b61d36aa2080b0b00d5641c6d58a2f84133e5eaebb131a4515d686"},"mac":"279bca30c15b7be0f77c0dbb97049acf1d0e2acfaf94683ccb7964bb4490ec3b"},"id":"aecc3e3e-851f-4e64-ae81-df5bf9f8009c","version":3}'
     ```
     或者 `export ATTACKER_KEYSTORE="$(cat attacker_keystore.json)"`。
3. 在恶意流量节点运行 `python3 ddos_attack_sender.py --ipc /root/Work/PraviteChain/geth.ipc --mode dup_nonce --count 200 --passphrase 123`（或 `--rpc http://<远程节点>:8545` 远程触发，必要时可指定 `--from-index` / `--target`，使用 keystore 时需配合 `--passphrase` 解密）。
4. 在 10 s 暂停期间复制标准输出中的命令（示例：`export ATTACKER_ACCOUNTS=0x攻击地址1,0x攻击地址2`，可用逗号或分号分隔）到监测节点执行，确保检测脚本识别攻击来源。
5. 在监测节点运行 `python3 ddos_monitor.py --ipc /root/Work/PraviteChain/geth.ipc --legit-rpc http://<合法节点>:8545 --attack-rpc http://<恶意节点>:8545 --supplement-rpc http://<普通节点>:8545 --window 30 --output metrics.jsonl`，若第三探针不可达会自动退化为仅使用本地节点的分子数据。必要时附加 `--tcpdump iface0.pcap` 来整合抓包数据。
6. 监测脚本实时输出“累计 LTR/MTR”与“30 秒滑动窗口 LTR/MTR”两组数据；若某个分母探针缺失，则自动回退到本地统计基数，并在标准输出中维持固定格式方便比对。
7. 测试结束后，整理监测脚本输出与关键参数，连同网络拓扑和节点日志摘要存档，形成 DDoS 交易广播转发抵抗能力测量报告。



