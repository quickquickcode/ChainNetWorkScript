3.2.3.21 热点合约抢跑率 (Hot Contract Front-running Rate)
===============================================

定义
----
热点合约抢跑率衡量前置检测算法识别出的前置交易中，有多少在同一时间窗口内集中于“热点合约”。热点集合不再依赖静态名单，而是由监测脚本基于 RPC 观测到的交易分布动态划定，并结合触发器提供的真值进行验证：

\[ HCR = \frac{|H_{truth}|}{|A_{truth}|} \]

- `A_{truth}`：触发器在监测窗口内生成、并被监测脚本识别到的全部真值事件；
- `H_{truth}`：其中目标部署地址被监测脚本判定为“热点”（在窗口内的检测占比超过阈值）的事件集合。

监测脚本会额外打印 precision / recall、热门合约 Top-N、误报/漏报等诊断指标，方便定位检测逻辑是否偏离真值，但核心指标仍以上方公式定义的 `A_truth`、`H_truth` 为准。

数据来源与职责分工
--------------------
1. **热点专用触发器**（`front_run/3.2.3.21热点合约抢跑率/hotspot_trigger.py`）：
	- 最少需要一个 HTTP RPC 节点（`--rpc` 可多次填写）以及导入的 `ATTACKER_KEYSTORE`；
	- 接收 `--target`（复数）指定现有合约地址，可配合 `--hot-contract` 与 `--hot-share` 控制热点事件比例（默认首个目标为热点）；
	- 支持 `--victim-gas-price`（默认读取节点建议）、`--runner-premium`、`--transfer-amount`、`--interval`、`--dry-run` 等参数调节交易形态；
	- 每对 victim/runner 交易都会写入 `fr-hotspot-tx-v1`（带 `is_hot_truth` 与 `pair_id`），并将完整真值落盘为 `fr-hotspot-event-v1`；
	- 可选通过 `--pipe` 向命名管道实时推送交易与 `fr-hotspot-metadata-v1`，供监测脚本即时消费。
2. **监测脚本**（`front_run/3.2.3.21热点合约抢跑率/fr_hotspot_monitor.py`）：
	- 将同一命名管道与触发器落盘的 ground-truth JSONL 作为输入；
	- 通过 `--rpc` 访问 Geth 节点 `txpool.content()`，轮询最新待打包交易；
	- 依据触发器 marker 匹配 victim/runner，并用 `--premium-ratio` / `--premium-absolute` 判定抢跑关系；
	- 在滑动窗口（`--window`）内累计每个合约的检测占比，超过 `--hot-threshold` 的即视为热点；
	- 输出 `[STATUS]` / `[SUMMARY]`，统计 `truth_events`、`det_events`、`precision`、`recall` 以及热点占比，`--output` 则追加 `fr-hotspot-detector-v1` JSON 行。
3. **RPC 节点**：需开放 `txpool` 与基础 `eth_*` 接口；若配置多个 `--rpc`，脚本会轮询分担负载。全部节点的链 ID 必须一致。

检测算法概述
------------
1. 监听命名管道，首先读取 `fr-hotspot-metadata-v1` 获取热点配置（真值集合、目标列表等）；
2. 同步 ground-truth JSONL（`fr-hotspot-event-v1`）与实时 `fr-hotspot-tx-v1`，按 `pair_id` 维护真值状态；
3. 持续通过 RPC 轮询 `txpool.content()`，将本地观察到的 victim/runner 交易与真值索引对齐；
4. 优先尝试 `--premium-ratio` / `--premium-absolute` 判定抢跑关系；若节点返回的 txpool 交易缺乏 gas 信息，则退化为按 `to` 地址与真值目标匹配后直接记入滑动窗口；
5. 在窗口内统计各合约的检测占比，超过 `--hot-threshold` 的地址组成热点集合；
6. 将热点集合与触发器真值比对，输出 precision / recall、热点榜单与单笔 JSONL（若启用 `--output`）。

标准流程
--------
1. **准备命名管道与真值文件**：确保实验节点具备 POSIX FIFO（Windows 可改用 `pywin32` 命名管道或跳过 `--pipe`）。示例：
   ```sh
   mkfifo /tmp/fr_hotspot.pipe
   touch front_run/hotspot_ground_truth.jsonl
   ```
2. **启动监测脚本**（需先保证 RPC 结点开放 `txpool`）：
   ```sh
   python3 front_run/fr_hotspot_monitor.py \
	   --pipe /tmp/fr_hotspot.pipe \
	   --ground-truth front_run/hotspot_ground_truth.jsonl \
	   --rpc http://202.118.4.18:8545 \
	   --window 100 \
	   --hot-threshold 0.2 \
	   --output front_run/hotspot_detections.jsonl
   ```
   - 可根据需要增加 `--rpc`、`--poll-interval`、`--premium-ratio`、`--allow-missing-marker` 等参数。
3. **运行热点触发器**：
   ```sh
   export ATTACKER_KEYSTORE='{"address":"5631d0d3145bf370673d6eadf6d29657f934c542","crypto":{"cipher":"aes-128-ctr","ciphertext":"98553dd168cb6da7feb3a9a3a60242c19cf827b6b4ed0448e8ea145bbd2b0b77","cipherparams":{"iv":"38d623ec857612011511e41eaa1cefd6"},"kdf":"scrypt","kdfparams":{"dklen":32,"n":262144,"p":1,"r":8,"salt":"7877745b08004d6737b64d8b9889192fb68e45e4f2ee18991c1e482bfea59ca5"},"mac":"719446ed9f31a6c7ac6a717f1ab25d09eaa2583424e04ecba3c84205d076b539"},"id":"87d68304-c29c-4b9b-bec0-300b8af1d0ba","version":3}'
   python3 front_run/3.2.3.21热点合约抢跑率/hotspot_trigger.py \
	   --rpc http://202.118.4.18:8545 \
	   --count 120 \
	   --target 0xC0ffee254729296a45a3885639AC7E10F9d54979 \
	   --hot-contract 0xC0ffee254729296a45a3885639AC7E10F9d54979 \
	   --hot-share 0.6 \
	   --runner-premium 30gwei \
	   --pipe /tmp/fr_hotspot.pipe \
	   --output front_run/hotspot_ground_truth.jsonl
   ```
   - 触发器会请求 `--passphrase`（未提供则交互式输入）；支持同时提供多个 `--target`、`--rpc` 分担流量；`--dry-run` 可用于离线调试。
4. **实时观察**：`fr_hotspot_monitor.py` 每 `--status-interval` 秒打印一次
   ```
   [STATUS] truth_events=… det_events=… precision=… recall=… hotspots=['0x…:65.00%', …]
   ```
   若 RPC 或管道异常会输出 `[WARN]`；达到阈值的热点列表会同步展示。
5. **汇总评估**：用 `Ctrl+C` 停止监测后得到 `[SUMMARY]` 与热点 Top-N，`front_run/hotspot_ground_truth.jsonl` 和 `front_run/hotspot_detections.jsonl` 可供离线分析与回放。

记录与追溯
----------
- `front_run/hotspot_ground_truth.jsonl`：触发器真值记录（`schema=fr-hotspot-event-v1`），带 `is_hot_truth`、`pair_id`、`target_address`；
- `front_run/hotspot_detections.jsonl`：监测脚本可选输出（`schema=fr-hotspot-detector-v1`），记录延迟、溢价、目标与检测时间；
- 终端日志：监测脚本输出 `[STATUS]`、`[SUMMARY]`、热点榜单，触发器输出 `[PAIR]`、`[FUND]` 等事件；
- 管道数据：实时 `fr-hotspot-metadata-v1`、`fr-hotspot-tx-v1` JSON 行，可用 `jq` 或自定义脚本进行回放。

伪代码
------
```
truth_states = {}
detections = deque()

while running:
	for payload in drain_fifo():
		if payload.schema == "fr-hotspot-metadata-v1":
			truth_hot = set(payload.hot_contracts)
		elif payload.schema in {"fr-hotspot-tx-v1", "fr-hotspot-event-v1"}:
			truth_states[payload.pair_id] = merge(truth_states[payload.pair_id], payload)

	for tx in poll_txpool(rpc):
		obs = observe_tx(tx)
		match = match_truth(obs, truth_states)
		if match and is_front_run(match, obs):
			detections.append((now(), match.target, obs))

	cleanup(detections, window)
	shares = compute_share(detections)
	hotset = {addr for addr, share in shares.items() if share >= hot_threshold}
	metrics = compare_truth(truth_states, hotset)
	log_status(metrics, hotset)
```

实现注意事项
------------
- 触发器需保证 `ATTACKER_KEYSTORE` 与 `--passphrase` 可用，且主账户余额覆盖子账户资金与链上手续费；
- `--hot-share` 会被强制截断至 `[0,1]` 区间；`--dry-run` 可生成真值而不广播交易，适用于流程调试；
- 监测脚本必须在具备 `txpool` 权限的 Geth 环境运行；若节点不支持 `txpool.content()` 将立即退出；
- 多个 `--rpc` 会轮询使用，以降低单节点压力；窗口参数（`--window`、`--poll-interval`、`--block-interval`）需与实验持续时间匹配；
- 命名管道写入方（触发器）需要等监测脚本先 `open` FIFO，否则会在 10 秒后超时退出；
- 如果无法提供命名管道，可省略 `--pipe` 并仅依赖 ground-truth 文件，但实时指标会滞后；
- 建议在每次实验前清空旧的 JSONL 以免监测脚本重复读取历史记录。