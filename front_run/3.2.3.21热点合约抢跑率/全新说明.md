3.2.3.21 热点合约抢跑率 (Hot Contract Front-running Rate)
===============================================

定义
----
热点合约抢跑率衡量检测系统识别出的抢跑事件中，目标受害合约属于预先维护的“热点名单”的占比。热点名单以静态文件 `front_run/hot_contracts.txt` 提供，每行一个 0x 地址，可附带注释说明来源或版本号。

指标体系
--------
- `A`：测量窗口内识别出的抢跑事件集合（沿用成功率指标的事件抽取逻辑）。
- `H`：事件中受害合约在热点名单中的子集。按 victim 交易首个调用的合约地址匹配，若合约不在名单则标记为普通事件。

热点合约抢跑率定义为：

\[ HCR = \frac{|H|}{|A|} \]

当 `A = 0`，脚本输出“无样本”提示，并给出当前使用的热点名单版本。

观测数据来源
------------
1. **统一触发器**：`fr_trigger.py` 生成 victim/runner 对；当需要测试热点指标时，可指定 `--victim-contract` 选项覆盖受害合约地址，或通过 `--contracts` 部署内置合约并由脚本轮询使用目标地址。触发器会在 ground-truth 中记录 `target_address`，并将每笔交易推送到命名管道（若设置 `--pipe`），监测脚本可直接解析 `fr-trigger-tx-v1` 实时得知交易目的地址。
2. **静态热点文件**：`hot_contracts.txt` 提前维护，每行格式 `0xContractAddress # optional note`。检测脚本在启动时读取全部地址，生成哈希集合用于快速匹配。
3. **监测脚本**：`fr_hotspot_monitor.py` 复用命名管道流与 pending 轮询逻辑，解析 victim 交易的 `to` 地址及外部合约调用（如 calldata 中的目标合约），并将事件标记为热点/非热点。

实验流程
--------
1. **更新热点名单**：编辑 `hot_contracts.txt`，确保包含时间戳或版本号备注，并将文件同步至观测节点。
1. **准备命名管道并启动热点监测脚本**：
	 ```sh
	 mkfifo /tmp/fr_events.pipe
	 touch front_run/events_ground_truth.jsonl
	 python3 front_run/3.2.3.21热点合约抢跑率/fr_hotspot_monitor.py \
		 --pipe /tmp/fr_events.pipe \
		 --ground-truth front_run/events_ground_truth.jsonl \
		 --hot-contracts front_run/hot_contracts.txt \
		 --list-version hotlist-20251103 \
		 --output front_run/hotspot_events.jsonl
	 ```
	 - `--hot-contracts` 指向热点名单文件，脚本启动时立即加载，并按 `--refresh-interval`（默认 30 s）自动检测文件更新。
	 - `--ground-truth` 用于补齐 `event_id`/`pair_id`，如需离线复盘可持续追加写入。
	 - 如需仅在终端查看统计，可省略 `--output`。
2. **运行触发器**：
	 ```sh
    export ATTACKER_KEYSTORE='{"address":"5631d0d3145bf370673d6eadf6d29657f934c542","crypto":{"cipher":"aes-128-ctr","ciphertext":"98553dd168cb6da7feb3a9a3a60242c19cf827b6b4ed0448e8ea145bbd2b0b77","cipherparams":{"iv":"38d623ec857612011511e41eaa1cefd6"},"kdf":"scrypt","kdfparams":{"dklen":32,"n":262144,"p":1,"r":8,"salt":"7877745b08004d6737b64d8b9889192fb68e45e4f2ee18991c1e482bfea59ca5"},"mac":"719446ed9f31a6c7ac6a717f1ab25d09eaa2583424e04ecba3c84205d076b539"},"id":"87d68304-c29c-4b9b-bec0-300b8af1d0ba","version":3}'
	 python3 fr_trigger.py \
		 --rpc http://202.118.14.15:8545 \
		 --count 200 \
		 --marker 0xfeedface \
		 --victim-contract 0xHotContractAddr \
		 --pipe /tmp/fr_events.pipe \
		 --output front_run/events_ground_truth.jsonl
	 ```
3. **触发期间持续监测**：
	 热点监测脚本持续消费管道并结合 ground-truth 进行热点判定；若热点名单更新，会在终端打印 `[INFO]` 日志并即时应用。
4. **汇总指标**：脚本在 idle timeout 到达时输出 `|H|`、`|A|`、`HCR`，并记录热点名单版本。

记录与追溯
----------
- `hot_contracts.txt`：静态热点名单，建议采用 `地址 # 版本/来源` 格式。
- `hotspot_events.jsonl`：输出 JSONL，包含 `pair_id`、`event_id`、`target_address`、`is_hot`、`list_version`、`first_seen` 等字段。
- 终端输出：显示热点命中分布，若存在多个合约命中，可附带 Top-N 列表协助评估热点覆盖度。

伪代码
------
```
加载配置()
hotlist = 解析文件 -> {地址集合, 版本号, 哈希}
事件索引 = {}

监听 FIFO, 将 role=victim/runner 的记录按 pair_id 写入事件索引

循环直到停止:
	从 ground_truth 读取增量补齐 event_id / target_address
	检查热点名单是否更新
	对每个事件:
		victim_addr = 直接读取 target_address
		是否命中 = victim_addr in hotlist
		首次标记后写入 hotspot_events.jsonl，并累积 total/hot 计数

统计 |A|、|H|
输出 HCR 及热点命中明细
```

实现注意事项
------------
- 对于调用链触发二级合约的事件，脚本应至少记录首个外部调用（可解析 `input` 中 4 字节函数选择器，若指向代理合约需额外解析）；若暂时无法解析多级调用，可在结果中标记“可能遗漏”并记录受害合约地址。
- 热点名单长期维护需配合版本控制。脚本打印 `hotlist_hash`（对文件内容做 SHA256）以方便结果核对。
- 当触发器批量向同一热点合约发起 victim 交易时，HCR 应接近 1，用于验证检测链路的准确性；若未命中则说明解析流程存在缺陷，需要优先修复。
- 命名管道若意外断连，监测脚本需回退到纯 RPC 模式，并在结果中记录数据来源（pipe/RPC）占比。