3.2.3.19 恶意交易攻击流量传播范围
==================================

定义
----
衡量恶意交易流量在链网内部传播的广度与速度，反映攻击对整体网络造成的覆盖面和扩散效率。恶意交易定义与其他指标一致：`input` 前缀持有固定标记 `0xdeaddead`，多数交易使用标准 gas limit 以便进入 mempool，少量交易采用重复 nonce、低 gas price 或略低 intrinsic 的 gas limit，用于验证节点拒绝时的处理链路。

指标
----
1. **攻击流量占比 ATR (Attack Traffic Ratio)**：在观测节点集合中，恶意交易笔数占总交易笔数的比例。
   - 公式：`ATR = Σ_i M_i / Σ_i (M_i + C_i)`
   - `M_i`：节点 i 在观测窗口内识别到的恶意交易笔数（任意状态，包括 pending、queued、被拒绝）；
   - `C_i`：节点 i 在同一窗口内的正常交易笔数（`input` 不带标记）。
2. **覆盖节点率 CR (Coverage Ratio)**：在观测窗口内至少观测到一笔恶意交易的节点比例。
   - 公式：`CR = N_seen / N_nodes`
   - `N_seen`：`M_i > 0` 的节点数量；`N_nodes`：所有投入观测的节点数量。
3. **跨节点传播时差 PT (Propagation Time)**：恶意交易在观测节点之间传播所需的平均时间。
   - 公式：`PT = (1 / N_path) * Σ (t_last - t_first)`
   - `t_first` / `t_last`：该交易在观测节点中的最早 / 最晚首见时间；`N_path`：能在至少两个节点观察到的恶意交易数量。

测量方案
--------
- **数据采集**：观测脚本为每个 RPC 端点建立独立连接，周期性抓取 `txpool.content` 中恶意与正常交易数量，记录标记交易的首见时间、所在节点，并同步抓取 `eth_getTransactionByHash` 以确认其后续状态。
- **数据整理**：汇总程序按节点维度累加 `M_i` 与 `C_i`，在同一时间窗口内计算恶意交易占比；通过检测 `M_i > 0` 判定节点是否纳入覆盖集合；对每笔恶意交易建立跨节点的首见时间列表。
- **传播分析**：对于首见时间列表长度 ≥ 2 的交易，计算最早与最晚出现之间的时间差，收集所有样本的平均值作为 PT；若某节点长期未观测到恶意交易，汇总结果中会标记该节点的采样数量，便于追查。
- **结果输出**：最终输出 ATR、CR、PT 及每个节点的基础统计，并附带观测窗口设置、节点列表和样本数量，以支持不同实验之间的对比。

操作步骤
--------
1. **部署观测脚本**：在三个或以上节点分别运行 `detect_spread.py`，参数中写明所有 RPC 地址，确保脚本可同时连接多个节点获取数据。
2. **启动触发脚本**：运行 `python3 malicious_trigger.py --marker 0xdeaddead --ratio-reject 0.2 --rpc http://nodeA:8545`，同时保持背景合法交易。
3. **观测窗口**：保持两类脚本同时运行至少 `10 × poll_interval`，保证统计稳定。
4. **结束流程**：先停止触发脚本，再等待 1~2 个轮询周期让传播收尾，最后停止观测脚本。
5. **指标计算**：
   - 执行 `python3 summarize_spread.py spread.jsonl` 输出 `ATR`、`CR`、`PT` 以及每个节点的采样数量；
   - 对低于阈值的节点（例如 `M_i < 5`）进行标记，便于排查。

伪代码
--------
```
解析命令行参数（--rpc 多次、标记前缀、轮询间隔、统计窗口、输出文件）
为每个 RPC 创建客户端，初始化 per_node 统计（M_i、C_i、首见时间表）

循环执行：
   now = 当前时间
   对每个节点：
      调用 txpool.content
      统计该节点在本轮看到的恶意交易数量与正常交易数量，并累计到 per_node
      对于恶意交易：
         若首见时间表中无该哈希，记录 first_seen[hash].append((node, now))
   可选：针对新增哈希调用 eth_getTransactionByHash，记录是否已上链
   将本轮节点级计数与新增首见记录写入 JSONL
   睡眠轮询间隔

结束后：
   对每个节点输出累计的 M_i、C_i
   对每笔交易的首见列表进行去重，计算首见节点数量和最早/最晚时间
   将时间差集合交给 summarize_spread.py，以计算 ATR、CR、PT
```