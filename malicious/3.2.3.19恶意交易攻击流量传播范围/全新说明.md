3.2.3.19 恶意交易攻击流量传播范围
==================================

定义
----
衡量恶意交易流量在链网内部传播的广度与速度，反映攻击对整体网络造成的覆盖面和扩散效率。恶意交易定义与其他指标一致：`input` 前缀持有固定标记 `0xdeaddead`，多数交易使用标准 gas limit 以便进入 mempool，少量交易采用重复 nonce、低 gas price 或略低 intrinsic 的 gas limit，用于验证节点拒绝时的处理链路。

指标
----
1. **攻击流量占比 ATR (Attack Traffic Ratio)**：在观测节点集合中，恶意交易笔数占总交易笔数的比例。
   - 公式：`ATR = Σ_i M_i / Σ_i (M_i + C_i)`
   - `M_i`：节点 i 在观测窗口内识别到的恶意交易笔数（任意状态，包括 pending、queued、被拒绝）；
   - `C_i`：节点 i 在同一窗口内的正常交易笔数（`input` 不带标记）。
2. **覆盖节点率 CR (Coverage Ratio)**：在观测窗口内至少观测到一笔恶意交易的节点比例。
   - 公式：`CR = N_seen / N_nodes`
   - `N_seen`：`M_i > 0` 的节点数量；`N_nodes`：所有投入观测的节点数量。
3. **跨节点传播时差 PT (Propagation Time)**：恶意交易在观测节点之间传播所需的平均时间。
   - 公式：`PT = (1 / N_path) * Σ (t_last - t_first)`
   - `t_first` / `t_last`：该交易在观测节点中的最早 / 最晚首见时间；`N_path`：能在至少两个节点观察到的恶意交易数量。

测量方案
--------
- **采集方式**：
   - 运行专用脚本 `python3 detect_spread.py --marker 0xdeaddead --rpc http://nodeA:8545 --rpc http://nodeB:8545 --rpc http://nodeC:8545 --output spread.jsonl`；
   - 脚本对每个节点调用 `txpool.content` 与 `eth_getTransactionByHash`，统计标记交易与普通交易数量，并记录首见时间。
- **数据整理**：
   - `M_i`、`C_i`：分别来自脚本在窗口内累积的恶意 / 正常交易计数；
   - `CR`：检查每个节点的 `M_i` 是否大于 0；
   - `PT`：对每笔恶意交易取不同节点的首见时间差。
- **时钟同步**：观测节点需提前执行 NTP 同步，脚本输出中附带 `node_id` 与本地时间，必要时可用合法交易首见时间对齐偏差。

操作步骤
--------
1. **部署观测脚本**：在三个或以上节点分别运行 `detect_spread.py`，参数中写明所有 RPC 地址，确保脚本可同时连接多个节点获取数据。
2. **启动触发脚本**：运行 `python3 malicious_trigger.py --marker 0xdeaddead --ratio-reject 0.2 --rpc http://nodeA:8545`，同时保持背景合法交易。
3. **观测窗口**：保持两类脚本同时运行至少 `10 × poll_interval`，保证统计稳定。
4. **结束流程**：先停止触发脚本，再等待 1~2 个轮询周期让传播收尾，最后停止观测脚本。
5. **指标计算**：
   - 执行 `python3 summarize_spread.py spread.jsonl` 输出 `ATR`、`CR`、`PT` 以及每个节点的采样数量；
   - 对低于阈值的节点（例如 `M_i < 5`）进行标记，便于排查。