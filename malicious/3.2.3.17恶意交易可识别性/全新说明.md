3.2.3.17 恶意交易可识别性
===========================

定义
----
衡量链网节点在正常运行时，通过自身协议反馈（RPC 错误、交易回执、txpool 状态）向外部暴露恶意交易的能力。恶意交易统一定义为：`input` 前缀带有固定标记（例如 `0xdeaddead`）的交易，其中大部分使用标准 gas limit 进入交易池，少量刻意降低 gas limit 或构造可判定失败的参数，用于触发节点拒绝逻辑。

指标
----
1. **恶意交易可见率 VR (Visibility Ratio)**：在观测节点采集到的恶意交易中，被判定为“拒绝或未进入交易池”的比例。
   - 公式：`VR = N_reject / N_total`
   - `N_total`：观测脚本识别到、`input` 前缀匹配的交易数量。
   - `N_reject`：在 `txpool.content` 中长期缺失、或通过 RPC 返回错误（例如 `intrinsic gas too low`、`replacement underpriced`）被记录为拒绝的交易数量。
2. **拒绝反馈覆盖率 FR (Feedback Ratio)**：被拒绝的恶意交易中，节点能够给出明确错误原因的占比。
   - 公式：`FR = N_reason / N_reject`
   - `N_reason`：在 RPC 响应、回执或监测日志中带有错误码/理由的交易数量。
3. **响应时延 AR (Attack Responsiveness)**：从交易首次被观察到，到节点给出拒绝反馈之间的平均耗时。
   - 公式：`AR = (1 / N_reject) * Σ (t_flag - t_first_seen)`
   - `t_first_seen`：观测脚本在任意节点首次捕获该交易的时间；`t_flag`：记录到拒绝事件（错误码或拒绝时间窗到期）的时间。

测量方案
--------
- **数据采集**：观测脚本周期性向多个 RPC 端点请求 `txpool.content` 与 `eth_getTransactionByHash`，过滤出 `input` 带标记前缀的交易，将“首见时间、所在节点、交易状态、错误信息”写入统一的 JSONL 结构。
- **状态归类**：对于每笔恶意交易，结合首见时间与后续轮询结果判断是否进入 `pending`、被替换、或在拒绝时间窗内未出现；脚本同时解析 RPC 错误返回和回执，将拒绝原因标准化（例如 `intrinsic gas too low`、`replacement underpriced`）。
- **指标计算**：在汇总阶段根据 JSONL 中的唯一哈希计数得到 `N_total`；对被归类为拒绝的记录统计 `N_reject`，并根据是否存在明确错误信息得到 `N_reason`；`AR` 通过对每条拒绝记录计算 `t_flag - t_first_seen` 并求平均获得。
- **结果输出**：汇总程序返回 VR、FR、AR 以及原始样本数量、拒绝窗口长度、覆盖节点列表，为不同实验的横向比较提供上下文。

操作步骤
--------
1. **准备环境**：
   - 攻击节点运行统一的触发脚本（示例：`python3 malicious_trigger.py --marker 0xdeaddead --ratio-reject 0.2`），随机混合普通传播型交易与少量触发拒绝的交易（如降低 gas limit、重复 nonce、低 gas price）。
2. **部署监测脚本**：
   - 在不少于两个节点执行 `python3 detect_visibility.py --rpc http://nodeA:8545 --rpc http://nodeB:8545 --marker 0xdeaddead --reject-window 10 --output visibility.jsonl`。
3. **采集阶段**：
   - 保持触发脚本与合法背景流量运行至少 `5 × reject-window`，期间监测脚本持续写入 JSONL。
4. **结束采集**：
   - 停止触发脚本并等待一个拒绝窗口，随后停止监测脚本。
5. **计算指标**：
   - 使用 `python3 summarize_visibility.py visibility.jsonl`，统计 `N_total`、`N_reject`、`N_reason`，并计算 VR、FR、AR；
   - 输出原始计数、拒绝窗口配置、参与的 RPC 节点列表。

伪代码
--------
```
解析命令行参数（包含多个 --rpc、标记前缀、轮询间隔、拒绝时间窗、输出文件）
初始化 RPC 连接列表与交易跟踪字典 tracked_tx

循环执行：
   获取当前时间 now
   对每个 RPC 节点：
      调用 txpool.content
      遍历 pending/queued 中的交易，若 input 以 marker 开头：
         若哈希首次出现则在 tracked_tx 中创建记录，写入 first_seen=now、from、nonce，并记录来源节点
         若已存在则追加来源节点并更新 last_seen=now、最近状态="pool"
   对 tracked_tx 中状态未明确的交易：
      调用 eth_getTransactionByHash
      如果返回回执则更新 status 与 receipt_time
      若无回执且 now-first_seen 超过拒绝时间窗，则标记 status="rejected"、flag_time=now
      若最近一次 RPC 出现错误信息，也写入 error_reason
   将本轮状态变化写入 JSONL（含 tx_hash、first_seen、最新状态、来源节点、错误原因）
   睡眠轮询间隔

脚本结束时，可根据 tracked_tx 统计唯一哈希、拒绝数量及错误原因分布
```