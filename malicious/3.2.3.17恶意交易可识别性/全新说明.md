3.2.3.17 恶意交易可识别性
===========================

定义
----
衡量链网节点在正常运行时，通过自身协议反馈（RPC 错误、交易回执、txpool 状态）向外部暴露恶意交易的能力。恶意交易统一定义为：`input` 前缀带有固定标记（例如 `0xdeaddead`）的交易，其中大部分使用标准 gas limit 进入交易池，少量刻意降低 gas limit 或构造可判定失败的参数，用于触发节点拒绝逻辑。

指标
----
1. **恶意交易可见率 VR (Visibility Ratio)**：在观测节点采集到的恶意交易中，被判定为“拒绝或未进入交易池”的比例。
   - 公式：`VR = N_reject / N_total`
   - `N_total`：观测脚本识别到、`input` 前缀匹配的交易数量。
   - `N_reject`：在 `txpool.content` 中长期缺失、或通过 RPC 返回错误（例如 `intrinsic gas too low`、`replacement underpriced`）被记录为拒绝的交易数量。
2. **拒绝反馈覆盖率 FR (Feedback Ratio)**：被拒绝的恶意交易中，节点能够给出明确错误原因的占比。
   - 公式：`FR = N_reason / N_reject`
   - `N_reason`：在 RPC 响应、回执或监测日志中带有错误码/理由的交易数量。
3. **响应时延 AR (Attack Responsiveness)**：从交易首次被观察到，到节点给出拒绝反馈之间的平均耗时。
   - 公式：`AR = (1 / N_reject) * Σ (t_flag - t_first_seen)`
   - `t_first_seen`：观测脚本在任意节点首次捕获该交易的时间；`t_flag`：记录到拒绝事件（错误码或拒绝时间窗到期）的时间。

测量方案
--------
- **数据来源**：观测脚本定期轮询多个 RPC 节点的 `txpool.content`、`eth_getTransactionReceipt`、`eth_getTransactionByHash`，并将带标记前缀的交易写入 JSONL 日志。
- **判定方式**：
   - `N_total`：统计 JSONL 中出现的唯一恶意交易哈希数；
   - `N_reject`：对每笔交易计算首次观测时间与最新状态，若在拒绝时间窗内未进入 `pending` 或回执 `status=0`，则计入；
   - `N_reason`：解析 RPC 错误消息或回执中的 `revert reason`；
   - `AR`：对每笔被拒交易取 `t_flag - t_first_seen`。
- **脚本约束**：仅依赖 JSON-RPC；攻击触发脚本日志仅用于人工核对，不作为统计输入。

操作步骤
--------
1. **准备环境**：
   - 攻击节点运行统一的触发脚本（示例：`python3 malicious_trigger.py --marker 0xdeaddead --ratio-reject 0.2`），随机混合普通传播型交易与少量触发拒绝的交易（如降低 gas limit、重复 nonce、低 gas price）。
2. **部署监测脚本**：
   - 在不少于两个节点执行 `python3 detect_visibility.py --rpc http://nodeA:8545 --rpc http://nodeB:8545 --marker 0xdeaddead --reject-window 10 --output visibility.jsonl`。
3. **采集阶段**：
   - 保持触发脚本与合法背景流量运行至少 `5 × reject-window`，期间监测脚本持续写入 JSONL。
4. **结束采集**：
   - 停止触发脚本并等待一个拒绝窗口，随后停止监测脚本。
5. **计算指标**：
   - 使用 `python3 summarize_visibility.py visibility.jsonl`，统计 `N_total`、`N_reject`、`N_reason`，并计算 VR、FR、AR；
   - 输出原始计数、拒绝窗口配置、参与的 RPC 节点列表。*** End Patch