3.2.3.18 恶意交易轨迹追踪能力
===============================

定义
----
衡量链网在恶意交易流经节点后，能否依靠多节点的 RPC 观测记录出完整传播路径的能力。恶意交易同样定义为 `input` 前缀带固定标记（如 `0xdeaddead`）的交易，其中大部分以标准 gas limit 广播，少量故意触发拒绝（例如重复 nonce、低 gas price、略低于 intrinsic 的 gas limit），便于校验节点是否准确记录失败路径。

指标
----
1. **路径重建率 PR (Path Reconstruction Rate)**：被至少两个观测节点捕获、能够恢复传播顺序的恶意交易占比。
   - 公式：`PR = N_path / N_total`
   - `N_total`：观测脚本识别到的恶意交易数量；`N_path`：在两个及以上节点拥有“首次出现时间”的交易数量。
2. **账户路径覆盖率 AP (Address Path Coverage)**：至少有一笔交易可被重建路径的攻击账户占比。
   - 公式：`AP = N_addr_path / N_attackers`
   - `N_attackers`：观测脚本识别到的攻击账户数量；`N_addr_path`：拥有 `N_path` 交易的唯一账户数量。
3. **首尾观测时差 DT (Detection Time Spread)**：对可以重建路径的交易，记录在最早与最晚节点上的首见时间差平均值。
   - 公式：`DT = (1 / N_path) * Σ (t_last - t_first)`
   - `t_first` / `t_last`：该交易在观察节点集合中的最早 / 最晚首见时间。

测量方案
--------
- **数据来源**：专用观测脚本定期轮询多个 RPC 节点的 `txpool.content`，记录每个标记交易在各节点的首次出现时间、状态变化（进入 pending、被拒绝、被打包）。必要时辅以 `eth_getTransactionReceipt` 获取链上确认。
- **时间基准**：所有观测节点需提前完成 NTP 同步；脚本在写入 JSONL 时记录本地时间戳与节点标识。
- **路径判定**：
   - 若同一哈希在两个及以上节点有首见时间，即认为路径可重建；
   - 若仅某些节点记录到拒绝或上链事件，仍视为可构建路径，但 `t_last` 以该事件出现的节点时间为准。
- **账户归集**：依据交易 `from` 字段聚合攻击账户，计算 `AP`。

操作步骤
--------
1. **部署观测脚本**：在至少三个 RPC 节点运行 `python3 detect_paths.py --rpc http://nodeA:8545 --rpc http://nodeB:8545 --rpc http://nodeC:8545 --marker 0xdeaddead --output paths.jsonl`，脚本内部为每个节点单独维护首见时间。
2. **触发攻击**：执行 `python3 malicious_trigger.py --marker 0xdeaddead --ratio-reject 0.2 --rpc http://nodeA:8545`，并保持合法背景流量。
3. **观测周期**：维持触发脚本运行至少 `5 × poll_interval`，观测脚本持续写入 `paths.jsonl`。
4. **结束采集**：停止触发脚本，再等待一个轮询间隔后关闭观测脚本。
5. **指标计算**：
   - 运行 `python3 summarize_paths.py paths.jsonl` 解析首见时间矩阵，输出 `PR`、`AP`、`DT`；
   - 同时给出各节点的有效样本计数、时间窗口等信息，便于追溯。